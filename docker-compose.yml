services:
  lavalink:
    image: ghcr.io/nichschlagen/nichmusik-lavalink:latest
    environment:
      LAVALINK_PASSWORD: ${LAVALINK_PASSWORD}
    expose:
      - "2333"
    healthcheck:
      test: ["CMD-SHELL", "bash -lc 'echo > /dev/tcp/127.0.0.1/2333'"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s
    networks:
      - internal-net
      - internet-net
    restart: unless-stopped

  bot:
    image: ghcr.io/nichschlagen/nichmusik-bot:latest
    depends_on:
      lavalink:
        condition: service_healthy
    environment:
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      CLIENT_ID: ${CLIENT_ID}
      GUILD_ID: ${GUILD_ID}
      LAVALINK_HOST: lavalink
      LAVALINK_PORT: 2333
      LAVALINK_PASSWORD: ${LAVALINK_PASSWORD}
      LOG_LEVEL: error
    networks:
      - internal-net
      - internet-net
    init: true
    restart: unless-stopped

networks:
  internal-net:
    internal: true
  internet-net:
    driver: bridge